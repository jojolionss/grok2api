name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Ensure D1 + KV and generate CI configs
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import urllib.request
          
          token = os.environ.get("CLOUDFLARE_API_TOKEN", "")
          account_id = os.environ.get("CLOUDFLARE_ACCOUNT_ID", "")
          if not token or not account_id:
              raise SystemExit("Missing CLOUDFLARE_API_TOKEN or CLOUDFLARE_ACCOUNT_ID")

          def request(method: str, url: str, data=None):
              headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
              body = None if data is None else json.dumps(data).encode("utf-8")
              req = urllib.request.Request(url, data=body, headers=headers, method=method)
              with urllib.request.urlopen(req) as resp:
                  return json.loads(resp.read().decode("utf-8"))

          # === Ensure KV namespace ===
          kv_title = "grok2api-cache"
          kv_base = f"https://api.cloudflare.com/client/v4/accounts/{account_id}/storage/kv/namespaces"
          kv_id = None
          page = 1
          while True:
              res = request("GET", f"{kv_base}?per_page=100&page={page}")
              if not res.get("success"):
                  raise RuntimeError(res)
              for item in res.get("result", []):
                  if item.get("title") == kv_title:
                      kv_id = item.get("id")
                      break
              if kv_id:
                  break
              info = res.get("result_info") or {}
              if page >= int(info.get("total_pages") or 1):
                  break
              page += 1
          
          if not kv_id:
              res = request("POST", kv_base, {"title": kv_title})
              if not res.get("success"):
                  raise RuntimeError(res)
              kv_id = res["result"]["id"]

          # === Ensure D1 database ===
          d1_name = "grok2api"
          d1_base = f"https://api.cloudflare.com/client/v4/accounts/{account_id}/d1/database"
          d1_id = None
          page = 1
          while True:
              res = request("GET", f"{d1_base}?per_page=100&page={page}")
              if not res.get("success"):
                  raise RuntimeError(res)
              for item in res.get("result", []):
                  if item.get("name") == d1_name:
                      d1_id = item.get("uuid") or item.get("id")
                      break
              if d1_id:
                  break
              info = res.get("result_info") or {}
              if page >= int(info.get("total_pages") or 1):
                  break
              page += 1

          if not d1_id:
              res = request("POST", d1_base, {"name": d1_name})
              if not res.get("success"):
                  raise RuntimeError(res)
              d1_id = res.get("result", {}).get("uuid") or res.get("result", {}).get("id")
              if not d1_id:
                  raise RuntimeError({"error": "Missing D1 database id", "response": res})

          # === Generate backend config ===
          backend_src = open("wrangler.backend.toml", "r", encoding="utf-8").read()
          backend_dst = backend_src.replace("REPLACE_WITH_KV_NAMESPACE_ID", kv_id)
          backend_dst = backend_dst.replace("REPLACE_WITH_D1_DATABASE_ID", d1_id)
          open("wrangler.backend.ci.toml", "w", encoding="utf-8").write(backend_dst)

          # === Copy edge config (no replacements needed) ===
          edge_src = open("wrangler.edge.toml", "r", encoding="utf-8").read()
          open("wrangler.edge.ci.toml", "w", encoding="utf-8").write(edge_src)

          print(f"KV namespace ready: {kv_title} ({kv_id})")
          print(f"D1 database ready: {d1_name} ({d1_id})")
          print("Generated wrangler.backend.ci.toml and wrangler.edge.ci.toml")
          PY

      - name: Apply D1 migrations
        run: npx wrangler d1 migrations apply grok2api --remote --config wrangler.backend.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Deploy backend FIRST (edge depends on it via service binding)
      - name: Deploy Backend Worker
        run: npx wrangler deploy --config wrangler.backend.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Edge Worker
        run: npx wrangler deploy --config wrangler.edge.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
